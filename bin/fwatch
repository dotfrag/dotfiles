#!/bin/bash
#
# watch for file or directory changes and run command

if ! command -v entr > /dev/null; then
  echo "entr command not found."
  exit 1
fi

args=
while [[ $1 == -* ]]; do
  args="${args} $1"
  shift
done

f=$1
shift

handle_file() {
  # command is specified, use it
  # NOTE: when running a script e.g `./script arg1`,
  # you have to provide it twice: `fwatch script ./script arg1`
  if (($# > 0)); then
    # shellcheck disable=SC2086
    command ls "${f}" | entr -c ${args} "$@"
    return
  fi

  # no command has been specified, use magic
  if [[ -x ${f} ]]; then # file is executable, run it
    # shellcheck disable=SC2086
    command ls "${f}" | entr -c ${args} ./"${f}"
  else
    case "${f}" in
      .nvim.lua) cmd="zsh -ic nvim-trust" ;;
      *.hurl) cmd="hurl" ;;
      *) cmd="bat -pp" ;; # unknown filetype, cat it
    esac
    # shellcheck disable=SC2086
    command ls "${f}" | entr -c ${args} ${cmd} "${f}"
  fi
}

handle_dir() {
  if ! command -v fd > /dev/null; then
    echo "fd command not found."
    exit 1
  fi
  fd . "${f}" | entr -c "$@"
}

if [[ -f ${f} ]]; then
  handle_file "$@"
elif [[ -d ${f} ]]; then
  handle_dir "$@"
fi

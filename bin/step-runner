#!/bin/bash
#
# Script to run commands in steps and ability to continue from failed step

# Usage:
# source step-runner
# start_step [filepath]
# run_step script-one.sh
# run_step script-two.sh
# run_step script-three arg1 arg2
# stop_step

println() {
  if ((COLUMNS > 80)); then
    printf '=%.0s' {1..80}
    echo
  else
    printf '=%.0s' $(seq 1 "${COLUMNS}")
    echo
  fi
}

start_step() {
  session=${1:-/tmp/finishedSteps.txt}
  touch "${session}"
}

stop_step() {
  rm -f "${session}"
}

run_step() {
  if ! [[ -v session && -f ${session} ]]; then
    echo "File variable 'session' not defined."
    exit 1
  fi
  step=$*
  println
  echo "${step}"
  println
  if grep -q "${step}" "${session}"; then
    echo -e "Skipping..\n"
    return
  fi
  if ! ${step}; then
    println
    echo "ERROR: Failed at step ${step}"
    println
    echo "Saving current session in ${session}"
    exit 1
  fi
  echo "${step}" >> "${session}"
  echo
}
